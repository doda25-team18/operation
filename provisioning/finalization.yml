---
- name: Finalization
  hosts: all
  become: yes
  tasks:
    - name: Create metallb dir
      file:
        path: /metallb
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'

    - name: Download metallb
      get_url:
        url: https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml
        dest: /metallb/metallb.yaml
        mode: '0644'

    - name: Apply metallb
      become_user: vagrant
      command: kubectl apply -f /metallb/metallb.yaml


    - name: Wait for metallb to be ready
      become_user: vagrant
      shell: kubectl wait -n metallb-system -l app=metallb,component=controller --for=condition=ready pod --timeout=60s



    - name: Create MetalLB IPAddressPool
      copy:
        dest: /tmp/metallb-ip-pool.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: first-pool
            namespace: metallb-system
          spec:
            addresses:
              - 192.168.56.90-192.168.56.99

    - name: Apply IPAddressPool
      become_user: vagrant
      command: kubectl apply -f /tmp/metallb-ip-pool.yaml



    - name: Create MetalLB L2Advertisement
      copy:
        dest: /tmp/metallb-l2-advertisement.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: example
            namespace: metallb-system
          spec:
            ipAddressPools:
              - first-pool

    - name: Apply L2Advertisement
      become_user: vagrant
      command: kubectl apply -f /tmp/metallb-l2-advertisement.yaml

